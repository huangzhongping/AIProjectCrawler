name: Manual AI Trends Update

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - analysis
      data_file:
        description: 'æ•°æ®æ–‡ä»¶è·¯å¾„ï¼ˆä»…åˆ†æžæ¨¡å¼éœ€è¦ï¼‰'
        required: false
        type: string
      deploy_pages:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°GitHub Pages'
        required: true
        default: true
        type: boolean

jobs:
  manual-update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create config file
      run: |
        cp config/settings.yaml.example config/settings.yaml
        sed -i 's/your-openai-api-key-here/${{ secrets.OPENAI_API_KEY }}/g' config/settings.yaml
    
    - name: Create necessary directories
      run: |
        mkdir -p data/{raw,processed,archive}
        mkdir -p output/{reports,charts,web}
        mkdir -p logs
    
    - name: Run update (daily mode)
      if: ${{ github.event.inputs.mode == 'daily' }}
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        LOG_LEVEL: INFO
      run: |
        python main.py --mode daily
    
    - name: Run analysis (analysis mode)
      if: ${{ github.event.inputs.mode == 'analysis' }}
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        LOG_LEVEL: INFO
      run: |
        python main.py --mode analysis --data-file "${{ github.event.inputs.data_file }}"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ai-trends-report
        path: |
          output/
          data/processed/
        retention-days: 30
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Manual)"
        
        git add data/processed/
        git add output/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Manual update: $(date +'%Y-%m-%d %H:%M:%S') - Mode: ${{ github.event.inputs.mode }}"
          git push
        fi
    
    - name: Setup Pages
      if: ${{ github.event.inputs.deploy_pages == 'true' && github.ref == 'refs/heads/main' }}
      uses: actions/configure-pages@v3
    
    - name: Upload to GitHub Pages
      if: ${{ github.event.inputs.deploy_pages == 'true' && github.ref == 'refs/heads/main' }}
      uses: actions/upload-pages-artifact@v2
      with:
        path: output/web
    
    - name: Deploy to GitHub Pages
      if: ${{ github.event.inputs.deploy_pages == 'true' && github.ref == 'refs/heads/main' }}
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: Output summary
      run: |
        echo "## ðŸš€ AIè¶‹åŠ¿æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ¨¡å¼**: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²çŠ¶æ€**: ${{ github.event.inputs.deploy_pages == 'true' && 'å·²éƒ¨ç½²åˆ°GitHub Pages' || 'æœªéƒ¨ç½²' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "output/reports/ai-trends-$(date +'%Y-%m-%d').html" ]; then
          echo "- **æŠ¥å‘Šæ–‡ä»¶**: å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æŠ¥å‘Šæ–‡ä»¶**: ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
